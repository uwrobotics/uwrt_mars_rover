<?xml version="1.0" ?>
<robot name="uwrt_mars_rover_sim" xmlns:xacro="http://www.ros.org/wiki/xacro">

<xacro:include filename="$(find uwrt_mars_rover_description)/urdf/common.gazebo"/>
<xacro:include filename="$(find uwrt_mars_rover_description)/urdf/chassis/robot_chassis.gazebo"/>
<xacro:include filename="$(find uwrt_mars_rover_description)/urdf/chassis/robot_chassis.trans"/>

<xacro:property name="wheel_color" value="Gazebo/Silver"/>
<xacro:property name="rocker_color" value="Gazebo/Red"/>

<xacro:macro name="chassis_to_rocker" params="_suffix _side rotate base_object">
<!-- TODO: update COM of the rocker components -->
  <link name="rocker_${_suffix}">
    <inertial>
      <origin rpy="0 0 0" xyz="0.0003 0.02583 0.07381"/>
      <mass value="4.84"/>
      <inertia ixx="0.073122" ixy="-0.0001" ixz="0.00015" iyy="0.187572" iyz="0.02183" izz="0.15447"/>
    </inertial>
    <visual>
      <origin rpy="0 0 ${pi*rotate}" xyz="0 ${_side*0.0254} 0"/>
      <geometry>
        <mesh filename="package://uwrt_mars_rover_description/meshes/rocker.stl" scale="0.0254 0.0254 0.0254"/>
      </geometry>
      <material name="Red">
        <color rgba="1 0 0 1"/>
      </material>
    </visual>
    <collision>
      <origin rpy="0 0 ${pi*rotate}" xyz="0 ${_side*0.0254} 0"/>
      <geometry>
        <mesh filename="package://uwrt_mars_rover_description/meshes/rocker.stl" scale="0.0254 0.0254 0.0254"/>
      </geometry>
    </collision>
  </link>

  <xacro:basic_gazebo_ref link_name="rocker_${_suffix}" color="${rocker_color}"/>

  <!-- TODO: Make this a revolute rocker joint and write the differential bar transmission -->
  <joint name="rocker_${_suffix}_to_chassis" type="fixed">
    <origin xyz="0 ${_side*0.24289} 0" rpy="0.0 0.0 0.0"/>
    <parent link="${base_object}"/>
    <child link="rocker_${_suffix}"/>
    <!--<axis xyz="0.0 1.0 0.0"/>
    <limit lower="${-pi/4}" upper="${pi/4}" effort="100000" velocity="5"/>-->
  </joint>

  <xacro:macro name="rocker_to_wheel" params="suffix side reflect n_side">

    <link name="wheel_${suffix}_${side}">
      <inertial>
        <origin rpy="0 0 0" xyz="0 ${reflect*0.09398} 0"/>
        <mass value="1.32"/>
        <inertia ixx="0.0137" ixy="0" ixz="0" iyy="0.0191595" iyz="0" izz="0.0137"/>
      </inertial>
      <visual>
        <origin rpy="0 0 0" xyz="0 ${reflect*0.09398} 0"/>
        <geometry>
          <mesh filename="package://uwrt_mars_rover_description/meshes/wheel.stl" scale="0.0254 0.0254 0.0254"/>
        </geometry>
        <material name="body_color"/>
      </visual>
      <collision>
        <origin rpy="0 0 0" xyz="0 ${reflect*0.09398} 0"/>
        <geometry>
          <mesh filename="package://uwrt_mars_rover_description/meshes/wheel.stl" scale="0.0254 0.0254 0.0254"/>
        </geometry>
      </collision>
    </link>

    <joint name="wheel_${suffix}_${side}_to_rocker" type="continuous">
      <origin xyz="${n_side*0.381} ${reflect*0.07414} -0.15636" rpy="0.0 0.0 0.0"/>
      <parent link="rocker_${suffix}"/>
      <child link="wheel_${suffix}_${side}"/>
      <axis xyz="0.0 1.0 0.0"/>
    </joint>

    <xacro:wheel_gazebo wheel_link="wheel_${suffix}_${side}" color="${wheel_color}"/>

    <xacro:wheel_transmission link_name="wheel_${suffix}_${side}" joint_name="wheel_${suffix}_${side}_to_rocker" mech_reduction="43.8311688312"/>

  </xacro:macro>
  
  <xacro:if value="${_suffix == 'right'}">
    <xacro:rocker_to_wheel suffix="${_suffix}" side="back" reflect="-1" n_side="-1"/>
    <xacro:rocker_to_wheel suffix="${_suffix}" side="front" reflect="-1" n_side="1"/>
  </xacro:if>
  <xacro:if value="${_suffix == 'left'}">
    <xacro:rocker_to_wheel suffix="${_suffix}" side="front" reflect="1" n_side="1"/>
    <xacro:rocker_to_wheel suffix="${_suffix}" side="back" reflect="1" n_side="-1"/>
  </xacro:if>
    
</xacro:macro>
</robot>